name: Publish Python ðŸ distributions ðŸ“¦ to PyPI and TestPyPI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      publish_target:
        description: 'Where to publish (test or prod)'
        required: true
        default: 'test'

jobs:
  build-and-publish:
    name: Build, Test & Publish to TestPyPI/PyPI
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install PDM
      run: |
        curl -sSL https://pdm-project.org/install-pdm.py | python3 -
        pdm --version
    - name: Install project dependencies
      run: pdm install --dev
    - name: Run unit tests
      run: pdm run pytest

    - name: Build distributions
      run: pdm build --dest dist/

    - name: Publish to TestPyPI
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_target == 'test'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository-url: https://test.pypi.org/legacy/

    - name: Publish to PyPI
      if: >
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_target == 'prod')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }} 
        repository-url: https://upload.pypi.org/legacy/

