name: Publish Python üêç distributions

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  build-and-publish:
    name: Build & Publish to TestPyPI/PyPI
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    - name: Install PDM
      run: |
        curl -sSLO https://pdm-project.org/install-pdm.py | python -
        pdm --version

    - name: Run unit tests
      run: pdm run pytest

    - name: Build distributions
      run: pdm build --sdist --wheel --outdir dist/

    - name: Publish to TestPyPI
      if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
      uses: pypa/gh-action-pypi-publish@v1.5.3
      with:
        username: __token__
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository_url: https://test.pypi.org/legacy/

    - name: Publish to PyPI
      if: startsWith(github.ref, 'refs/tags/')
      uses: pypa/gh-action-pypi-publish@v1.5.3
      with:
        username: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
